name: mac-app-store-release

on:
  workflow_dispatch:
    inputs:
      upload:
        description: "Upload to App Store Connect"
        required: false
        default: true
        type: boolean
      app_version:
        description: "Marketing version / CFBundleShortVersionString (ex: 1.1.0). Leave empty to derive from tag or package.json"
        required: false
        default: ""
        type: string
      bundle_version:
        description: "CFBundleVersion override (ex: 1.1.12). Leave empty to use <app_version_major_minor>.<run_number>"
        required: false
        default: ""
        type: string
  push:
    tags:
      - "v*"

permissions:
  contents: read

jobs:
  release:
    runs-on: macos-14
    env:
      APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
      APPLE_API_ISSUER: ${{ secrets.APPLE_API_ISSUER }}
      MAS_CERTIFICATES_P12_BASE64: ${{ secrets.MAS_CERTIFICATES_P12_BASE64 }}
      MAS_CERTIFICATES_P12_PASSWORD: ${{ secrets.MAS_CERTIFICATES_P12_PASSWORD }}
      MAS_PROVISION_PROFILE_BASE64: ${{ secrets.MAS_PROVISION_PROFILE_BASE64 }}
      APP_STORE_CONNECT_API_KEY_P8_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_P8_BASE64 }}
      VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
      VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure Tag Commit Is On Main
        if: ${{ github.event_name == 'push' && github.ref_type == 'tag' }}
        shell: bash
        run: |
          set -euo pipefail
          git fetch --force origin +refs/heads/main:refs/remotes/origin/main
          if ! git merge-base --is-ancestor "$GITHUB_SHA" "refs/remotes/origin/main"; then
            echo "Tag '${GITHUB_REF_NAME}' points to commit '${GITHUB_SHA}', which is not on origin/main."
            exit 1
          fi

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Setup Rust Targets
        run: |
          rustup target add aarch64-apple-darwin x86_64-apple-darwin

      - name: Install Dependencies
        run: npm ci

      - name: Prepare Signing Assets
        run: |
          set -euo pipefail

          for key in \
            APPLE_API_KEY_ID \
            APPLE_API_ISSUER \
            MAS_CERTIFICATES_P12_BASE64 \
            MAS_CERTIFICATES_P12_PASSWORD \
            MAS_PROVISION_PROFILE_BASE64 \
            APP_STORE_CONNECT_API_KEY_P8_BASE64 \
            VITE_SUPABASE_URL \
            VITE_SUPABASE_ANON_KEY; do
            if [[ -z "${!key:-}" ]]; then
              echo "Missing required secret: $key"
              exit 1
            fi
          done

          KEYCHAIN_PATH="$RUNNER_TEMP/mas-signing.keychain-db"
          KEYCHAIN_PASSWORD="$(openssl rand -hex 18)"

          echo "$MAS_CERTIFICATES_P12_BASE64" | base64 -D > "$RUNNER_TEMP/mas-certs.p12"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security import "$RUNNER_TEMP/mas-certs.p12" \
            -k "$KEYCHAIN_PATH" \
            -P "$MAS_CERTIFICATES_P12_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security \
            -T /usr/bin/productbuild
          security set-key-partition-list \
            -S apple-tool:,apple:,codesign: \
            -s \
            -k "$KEYCHAIN_PASSWORD" \
            "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" "$HOME/Library/Keychains/login.keychain-db"
          security default-keychain -d user -s "$KEYCHAIN_PATH"

          mkdir -p "$HOME/.appstoreconnect/private_keys"
          echo "$APP_STORE_CONNECT_API_KEY_P8_BASE64" | base64 -D > "$HOME/.appstoreconnect/private_keys/AuthKey_${APPLE_API_KEY_ID}.p8"

          echo "$MAS_PROVISION_PROFILE_BASE64" | base64 -D > src-tauri/embedded.provisionprofile

      - name: Resolve App Version
        run: |
          set -euo pipefail

          if [[ -n "${{ github.event.inputs.app_version || '' }}" ]]; then
            APP_VERSION="${{ github.event.inputs.app_version }}"
          elif [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            APP_VERSION="${GITHUB_REF_NAME#v}"
          else
            APP_VERSION="$(node -p "require('./package.json').version")"
          fi

          if [[ "$APP_VERSION" =~ ^([0-9]+)\.([0-9]+)$ ]]; then
            APP_VERSION="${BASH_REMATCH[1]}.${BASH_REMATCH[2]}.0"
          fi

          if [[ ! "$APP_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid app version: $APP_VERSION"
            exit 1
          fi

          echo "Using app version: $APP_VERSION"
          echo "APP_VERSION=$APP_VERSION" >> "$GITHUB_ENV"

      - name: Apply App Version for Build
        run: |
          set -euo pipefail

          node -e 'const fs=require("fs"); const v=process.argv[1]; const pjPath="package.json"; const pj=JSON.parse(fs.readFileSync(pjPath,"utf8")); pj.version=v; fs.writeFileSync(pjPath, JSON.stringify(pj, null, 2)+"\n"); const tcPath="src-tauri/tauri.conf.json"; const tc=JSON.parse(fs.readFileSync(tcPath,"utf8")); tc.version=v; fs.writeFileSync(tcPath, JSON.stringify(tc, null, 2)+"\n");' "$APP_VERSION"

          node -e 'const fs=require("fs"); const v=process.argv[1]; const p="src-tauri/Cargo.toml"; let t=fs.readFileSync(p,"utf8"); t=t.replace(/(\[package\][\s\S]*?version\s*=\s*\")[^\"]+(\")/, `$1${v}$2`); fs.writeFileSync(p,t);' "$APP_VERSION"

      - name: Set Bundle Version for This Build
        run: |
          set -euo pipefail
          if [[ -n "${{ github.event.inputs.bundle_version || '' }}" ]]; then
            BUNDLE_VERSION="${{ github.event.inputs.bundle_version }}"
          else
            BUNDLE_PREFIX="${APP_VERSION%.*}"
            BUNDLE_VERSION="${BUNDLE_PREFIX}.${{ github.run_number }}"
          fi
          echo "Using bundle version: $BUNDLE_VERSION"
          node -e 'const fs=require("fs");const p="src-tauri/tauri.appstore.conf.json";const c=JSON.parse(fs.readFileSync(p,"utf8"));c.bundle=c.bundle||{};c.bundle.macOS=c.bundle.macOS||{};c.bundle.macOS.bundleVersion=process.argv[1];fs.writeFileSync(p,JSON.stringify(c,null,2)+"\n");' "$BUNDLE_VERSION"

      - name: Preflight Check
        run: npm run mas:check

      - name: Build App (MAS)
        run: npm run mas:build

      - name: Package PKG
        run: npm run mas:package

      - name: Upload PKG Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Torus-macappstore-pkg
          path: dist/Torus-macappstore.pkg
          if-no-files-found: error

      - name: Upload to App Store Connect
        if: ${{ github.event_name != 'workflow_dispatch' || inputs.upload }}
        run: npm run mas:upload
